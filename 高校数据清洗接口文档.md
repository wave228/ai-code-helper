# 高校数据清洗接口文档

## 项目概述

本项目使用Spring Boot + MyBatis-Plus构建了一个高校数据清洗和导入接口，能够将CSV格式的高校信息和录取分数数据清洗并导入到MySQL数据库中。

## 技术栈

- **框架**: Spring Boot 4.0.1
- **数据库**: MySQL 8.0
- **ORM**: MyBatis-Plus 3.5.3.1
- **语言**: Java 21
- **构建工具**: Maven

## 数据库设计

### universities表（高校基本信息）
```sql
CREATE TABLE universities (
    id INT PRIMARY KEY AUTO_INCREMENT,
    university_code VARCHAR(20),          -- 学校代码
    university_name VARCHAR(100),         -- 学校名称
    province VARCHAR(50),                 -- 所在省份
    city VARCHAR(50),                     -- 所在城市
    is_985 BOOLEAN,                       -- 是否985高校
    is_211 BOOLEAN,                       -- 是否211高校
    is_double_first_class BOOLEAN,        -- 是否双一流高校
    level VARCHAR(10),                    -- 学校等级(A/B/C等)
    category VARCHAR(10),                 -- 学校类别(1/2等)
    remark TEXT                           -- 备注信息
);
```

### admission_scores表（录取分数信息）
```sql
CREATE TABLE admission_scores (
    id INT PRIMARY KEY AUTO_INCREMENT,
    university_id INT,                    -- 关联universities表的id
    year INT,                             -- 年份(2022,2023,2024,2025)
    highest_score INT,                    -- 最高分
    lowest_score INT,                     -- 最低分
    average_score INT,                    -- 平均分(如果有)
    score_line INT,                       -- 分数线(如果有)
    ranking INT,                          -- 排名(位次)
    admission_count INT,                  -- 录取人数
    planned_count INT,                    -- 计划数
    FOREIGN KEY (university_id) REFERENCES universities(id)
);
```

## 项目结构

```
src/main/java/org/awave/aicodehelper/
├── entity/                          -- 实体类
│   ├── University.java              -- 高校实体
│   └── AdmissionScore.java          -- 录取分数实体
├── mapper/                          -- Mapper接口
│   ├── UniversityMapper.java        -- 高校数据访问接口
│   └── AdmissionScoreMapper.java    -- 录取分数数据访问接口
├── service/                         -- 业务逻辑层
│   └── UniversityDataService.java   -- 数据清洗服务
├── controller/                      -- 控制层
│   └── UniversityDataController.java -- 数据接口控制器
├── config/                          -- 配置类
│   ├── MybatisPlusConfig.java       -- MyBatis-Plus配置
│   └── MybatisScanConfig.java       -- Mapper扫描配置
└── AiCodeHelperApplication.java     -- 主启动类

src/main/resources/
├── mapper/                          -- XML映射文件
│   ├── UniversityMapper.xml         -- 高校SQL映射
│   └── AdmissionScoreMapper.xml     -- 录取分数SQL映射
├── docs/                            -- 数据文件
│   └── universities_data.csv        -- 高校数据CSV文件
└── application.yml                  -- 配置文件
```

## 核心功能

### 1. 数据清洗和导入

**接口**: `POST /api/university-data/clean-and-import`

**功能描述**:
- 读取CSV文件中的高校数据
- 智能解析和清洗数据字段
- 自动识别985/211/双一流标识
- 提取省份和城市信息
- 导入高校基本信息和历年录取分数

**数据清洗逻辑**:
1. **CSV解析**: 处理逗号在引号内的情况
2. **字段验证**: 检查字段数量和格式
3. **院校信息提取**:
   - 学校代码、名称、等级、类别
   - 从地域字段提取省份
   - 从地址字段智能提取城市
   - 从院校层次标识985/211/双一流
4. **录取分数处理**:
   - 解析2022-2025年历年分数
   - 计算平均分数
   - 支持数据去重和更新

### 2. 数据统计查询

**接口**: `POST /api/university-data/statistics`

**功能描述**:
- 获取数据库中的高校数量
- 统计录取分数记录数量
- 查看可用的年份数据

## MyBatis-Plus特性应用

### 1. 自动CRUD操作
- 使用`BaseMapper`提供的基础方法：`insert`, `delete`, `update`, `select`
- 无需编写简单的增删改查SQL

### 2. 条件构造器
```java
// 查询示例
University university = universityMapper.selectOne(
    new LambdaQueryWrapper<University>()
        .eq(University::getUniversityCode, universityCode)
);

// 删除示例
admissionScoreMapper.delete(
    new LambdaQueryWrapper<AdmissionScore>()
        .eq(AdmissionScore::getUniversityId, universityId)
);
```

### 3. XML映射文件（复杂操作）
```xml
<!-- 批量插入 -->
<insert id="batchInsert" parameterType="java.util.List">
    INSERT INTO universities (...) VALUES
    <foreach collection="list" item="item" separator=",">
        (#{item.universityCode}, ...)
    </foreach>
</insert>

<!-- 动态条件查询 -->
<select id="selectByCondition" parameterType="map" resultType="University">
    SELECT * FROM universities
    <where>
        <if test="province != null and province != ''">
            AND province = #{province}
        </if>
        <if test="is985 != null">
            AND is_985 = #{is985}
        </if>
    </where>
</select>
```

## 配置文件说明

### application.yml
```yaml
spring:
  datasource:
    url: jdbc:mysql://localhost:3306/university_db
    username: root
    password: password
    
mybatis-plus:
  configuration:
    map-underscore-to-camel-case: true  # 开启驼峰命名映射
  mapper-locations: classpath:mapper/*.xml  # XML映射文件路径
  type-aliases-package: org.awave.aicodehelper.entity  # 实体类包路径
```

## 使用说明

### 1. 环境准备
1. 安装MySQL 8.0+
2. 创建数据库：`university_db`
3. 修改`application.yml`中的数据库连接信息

### 2. 启动应用
```bash
mvn spring-boot:run
```

### 3. 调用接口
```bash
# 数据清洗和导入
curl -X POST http://localhost:8081/api/university-data/clean-and-import

# 获取统计信息
curl -X POST http://localhost:8081/api/university-data/statistics
```

### 4. 数据格式
CSV文件应包含以下字段（按顺序）：
- 学校代码、学校名称、等级、类别、院校层次、地域、地址
- 2022年最高分、最低分、位次、录取人数、计划数
- 2023年最高分、最低分、位次、录取人数、计划数
- 2024年最高分、最低分、位次、录取人数、计划数
- 2025年最高分、最低分、位次、录取人数、计划数

## 核心实体类

### University.java
```java
@Data
@TableName("universities")
public class University {
    @TableId(type = IdType.AUTO)
    private Long id;
    private String universityCode;
    private String universityName;
    private String province;
    private String city;
    private Boolean is985;
    private Boolean is211;
    private Boolean isDoubleFirstClass;
    private String level;
    private String category;
    private String remark;
}
```

### AdmissionScore.java
```java
@Data
@TableName("admission_scores")
public class AdmissionScore {
    @TableId(type = IdType.AUTO)
    private Long id;
    private Long universityId;
    private Integer year;
    private Integer highestScore;
    private Integer lowestScore;
    private Integer averageScore;
    private Integer scoreLine;
    private Integer ranking;
    /** 录取人数 */
    @TableField("admission_count")
    private Integer admissionCount;
    /** 计划数 */
    @TableField("planned_count")
    private Integer plannedCount;
}
```

## 错误处理

接口返回统一的JSON格式：
```json
{
    "success": true/false,
    "message": "操作结果描述",
    "data": {}
}
```

## 性能优化

1. **批量操作**: 使用XML映射文件实现批量插入
2. **事务管理**: 使用`@Transactional`确保数据一致性
3. **日志记录**: 详细的处理日志便于问题排查
4. **异常处理**: 完善的异常捕获和错误信息返回

## 扩展性

1. **数据源扩展**: 支持多种数据源配置
2. **字段扩展**: 实体类设计支持字段扩展
3. **查询扩展**: 条件构造器支持复杂查询需求
4. **接口扩展**: RESTful接口设计便于功能扩展

---

*文档最后更新: 2025年1月30日*